{{#section 'script'}}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.querySelectorAll('.formDeny').forEach(form => form.addEventListener('submit', e => {
        e.preventDefault();
        e.submitter.parentNode.innerHTML = `<span class="text-muted">Đã từ chối</span>`;
        e.target.submit();
    }));

    const formQuestion = document.querySelector("#formQuestion");
    if (formQuestion) {
        formQuestion.addEventListener('submit', e => {
            e.preventDefault();

            const content = document.querySelector("#question").value;
            if (!content) {
                Swal.fire({
                    icon: "error",
                    text: "Vui lòng nhập câu hỏi trước khi gửi.",
                });
                return;
            }

            e.target.submit();
        });
    }

    const formAnswer = document.querySelector("#formAnswer");
    if (formAnswer) {
        formAnswer.addEventListener('submit', e => {
            e.preventDefault();

            const content = document.querySelector("#answer").value;
            if (!content) {
                Swal.fire({
                    icon: "error",
                    text: "Vui lòng nhập câu trả lời trước khi gửi.",
                });
                return;
            }

            e.target.submit();
        });
    }

    const productId = '{{product.product_id}}';
    const currentPrice = '{{product.current_price}}';
    const stepPrice = '{{product.step_price}}';

    // watchlist 
    {{#if isAuthenticated}}
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            const response = await fetch(`/bidder/watchlist/check/${productId}`);
            const data = await response.json();
            
            const icon = document.getElementById('watchlistIcon');
            if (data.inWatchlist) {
                icon.classList.remove('bi-heart');
                icon.classList.add('bi-heart-fill');
            }
        } catch (error) {
            console.error(error);
        }

        // toggle 
        document.getElementById('watchlistBtn').addEventListener('click', async function() {
            console.log("hello");
            try {
                const response = await fetch(`/bidder/watchlist/toggle/${productId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                
                if (data.success) {
                    const icon = document.getElementById('watchlistIcon');
                    if (data.action === 'added') {
                        icon.classList.remove('bi-heart');
                        icon.classList.add('bi-heart-fill');
                    } else {
                        icon.classList.remove('bi-heart-fill');
                        icon.classList.add('bi-heart');
                    }
                    alert(data.message);
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error(error);
                alert('Có lỗi xảy ra');
            }
        });
        {{#if (not isSeller)}}
        // tinh minimum bid
        const minBid = parseInt(currentPrice) + parseInt(stepPrice);
        document.getElementById('minBidPrice').textContent = minBid.toLocaleString('vi-VN') + ' VNĐ';
        document.getElementById('bidAmount').min = minBid;

        // Confirm bid
        document.getElementById('confirmBidBtn').addEventListener('click', async function() {
            const bidAmount = parseFloat(document.getElementById('bidAmount').value);
            
            if (!bidAmount || bidAmount < minBid) {
                alert('Giá đặt không hợp lệ!');
                return;
            }

            if (!confirm(`Bạn có chắc chắn muốn đặt giá ${bidAmount.toLocaleString('vi-VN')} VNĐ?`)) {
                return;
            }

            try {
                const response = await fetch('/bidder/bid', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, bidAmount })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    
                    document.getElementById('currentPrice').textContent = 
                        data.newPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
                    document.getElementById('modalCurrentPrice').textContent = 
                        data.newPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
                    document.getElementById('bidCount').textContent = data.bidCount;
                    
                    bootstrap.Modal.getInstance(document.getElementById('bidModal')).hide();
                    document.getElementById('bidAmount').value = '';
                    
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error(error);
                alert('Có lỗi xảy ra khi đặt giá');
            }
        });
        {{/if}}
    });
    {{/if}}
</script>
{{/section}}

{{#if fromAdmin}}
<div class="container-md mt-3">
    <a href="/admin?proPage={{adminProPage}}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Quay về Admin
    </a>
</div>
{{/if}}

<div class="container-md my-5">
    <div class="row">
        <div class="col-md-7 mb-3 m-md-0">
            <div class="bg-body-secondary rounded mb-3" style="height: 500px;">
                <img src="{{main_image.image_url}}" alt="" class="object-fit-contain h-100 w-100 p-5">
            </div>

            <div id="carouselId" class="carousel carousel-dark slide">
                <div class="carousel-inner" role="listbox">
                    {{#each slides}}
                    <div class="carousel-item {{#if (eq @index 0)}}active{{/if}}">
                        <div class="row justify-content-center">
                            {{#each this}}
                            <div class="col-2" style="height: 100px;">
                                <img src="{{image_url}}" class="object-fit-contain h-100 w-100 d-block stretched-link" 
                                     alt="Product image" data-bs-toggle="modal" data-bs-target="#img{{@index}}" />
                            </div>
                            <div class="modal fade" id="img{{@index}}" tabindex="-1" role="dialog"
                                aria-labelledby="modalTitleId" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered" role="document">
                                    <div class="modal-content">
                                        <div class="modal-body">
                                            <img src="{{image_url}}" alt="" class="img-fluid">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {{/each}}
                        </div>
                    </div>
                    {{/each}}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselId" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselId" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </div>

        <div class="col-md-5">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h5 class="fw-bold">{{product.product_name}}</h5>
                {{#if isAuthenticated}}
                <button class="btn btn-outline-danger btn-sm" id="watchlistBtn" data-product-id="{{product.product_id}}">
                    <i class="bi bi-heart" id="watchlistIcon"></i>
                </button>
                {{/if}}
            </div>
            <hr>

            <div class="row">
                <div class="col-5">
                    <h6 class="fw-bold">Seller: {{seller.full_name}} 
                        <small class="text-muted">({{seller.total_rating}})</small>
                    </h6>
                    <p class="text-decoration-underline ps-2">
                        {{positive_percentage seller.rating_plus seller.total_rating}}% đánh giá tích cực
                    </p>
                </div>
                <div class="col-1">
                    <div class="vr" style="height: 100%;"></div>
                </div>
                {{#if top_bidder}}
                <div class="col-5">
                    <h6 class="fw-bold">Bidder dẫn đầu: {{mask_name top_bidder.full_name}}
                        <small class="text-muted">({{top_bidder.total_rating}})</small>
                    </h6>
                    <p class="text-decoration-underline ps-2">
                        {{positive_percentage top_bidder.rating_plus top_bidder.total_rating}}% đánh giá tích cực
                    </p>
                </div>
                {{/if}}
            </div>
            <hr>

            <h4>Giá hiện tại: <span class="fw-bold text-primary" id="currentPrice">{{format_currency product.current_price}}</span></h4>
            <p>Bước giá: <strong>{{format_currency product.step_price}}</strong></p>
            <p>Lượt ra giá: <strong id="bidCount">{{product.bid_count}}</strong></p>
            <p>Ngày mở bán: {{format_datetime product.created_at}}</p>
            <p class="text-danger">Ngày kết thúc: {{format_endDatetime product.end_time}}</p>
            <h4>Mua ngay với: <span class="fw-bold">{{format_currency product.buy_now_price}}</span></h4>
            
            {{#if isAuthenticated}}
            {{#if (not isSeller)}}
            <div class="mt-4">
                <button class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#bidModal">
                    <i class="bi bi-hammer"></i> Đặt giá
                </button>
                <a href="/bidder/bid-history/{{product.product_id}}" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-clock-history"></i> Xem lịch sử đấu giá
                </a>
            </div>
            {{/if}}
            {{else}}
            <div class="alert alert-info mt-4">
                <a href="/login">Đăng nhập</a> để tham gia đấu giá
            </div>
            {{/if}}
            <hr>
            {{#if isAuthenticated}}
            {{#if isSeller}}
            <h4 class="fw-semibold mt-3">Danh sách bidder ra giá</h4>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr class="text-center">
                            <th scope="col">#</th>
                            <th scope="col">Bidder</th>
                            <th scope="col">Hành động</th>
                        </tr>
                    </thead>
                    <tbody class="table-group-divider">
                        {{#each bidders}}
                        <tr class="text-center">
                            <th scope="row">{{inc @index}}</th>
                            <td>{{mask_name full_name}}</td>
                            <td>
                                <form class="formDeny" action="/denyBid" method="post">
                                    <input type="hidden" name="product_id" value="{{product_id}}">
                                    <input type="hidden" name="bidder_id" value="{{bidder_id}}">
                                    <div>
                                        {{#if is_denied}}
                                        <span class="text-muted">Đã từ chối</span>
                                        {{else}}
                                        <button type="submit" class="btn btn-primary">
                                            Từ chối ra giá
                                        </button>
                                        {{/if}}
                                    </div>
                                </form>
                            </td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
            <hr>
            {{/if}}
            {{/if}}
        </div>
    </div>

    <div class="container-fluid border mt-5 p-3">
        <h3 class="fw-bold">Mô tả sản phẩm</h3>
        {{{product.description}}}
    </div>
</div>


{{!-- UI giao dien dat gia --}}
{{#if (not isSeller)}}
<div class="modal fade" id="bidModal" tabindex="-1" aria-labelledby="bidModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bidModalLabel">Đặt giá</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Giá hiện tại:</label>
                    <p class="fw-bold text-primary" id="modalCurrentPrice">{{format_currency product.current_price}}</p>
                </div>
                <div class="mb-3">
                    <label class="form-label">Giá tối thiểu phải đặt:</label>
                    <p class="fw-bold" id="minBidPrice"></p>
                </div>
                <div class="mb-3">
                    <label for="bidAmount" class="form-label">Giá của bạn (VNĐ):</label>
                    <input type="number" class="form-control" id="bidAmount" 
                           placeholder="Nhập giá đặt" min="{{product.current_price}}" step="{{product.step_price}}">
                    <div class="form-text">Bước giá: {{format_currency product.step_price}}</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="confirmBidBtn">Xác nhận đặt giá</button>
            </div>
        </div>
    </div>
</div>
{{/if}}

<div class="container-fluid">
    <h1 class="fw-bold">Hỏi đáp</h1>
    <div class="container-fluid mb-5">
        <div class="card">
            <div class="card-body p-4 overflow-auto" style="max-height: 800px;">
                {{#each qa_list}}
                <div class="d-flex flex-start mb-4">
                    <img class="rounded-circle shadow-1-strong me-3" src="/icons/person-circle.svg" alt="avatar"
                        width="32" height="32" />
                    <div class="flex-grow-1 flex-shrink-1">
                        <div>
                            <div class="d-flex justify-content-between align-items-center">
                                <p class="mb-1">
                                    {{mask_name bidder.full_name}} <span class="small">- {{format_QAtime (convert_to_local created_at)}}</span>
                                </p>
                                {{#unless answer}}
                                {{#if ../isAuthenticated}}
                                {{#if ../isSeller}}
                                <a class="link-underline link-underline-opacity-0" data-bs-toggle="collapse" href="#collapse" aria-expanded="false" aria-controls="collapse"><i
                                        class="bi bi-reply"></i><span class="small">
                                        reply</span></a>
                                
                                
                                {{/if}}
                                {{/if}}
                                {{/unless}}
                            </div>
                            <p class="small mb-0">
                                {{question_text}}
                            </p>
                        </div>
                        <div class="d-flex flex-start mt-4">
                            <div class="collapse w-100" id="collapse">
                                <div class="card card-body">
                                    <form id="formAnswer" action="/product/answer" method="post">
                                        <textarea id="answer" class="form-control mb-3" rows="3" name="answer_text"></textarea>
                                        <input type="hidden" name="question_id" value="{{question_id}}">
                                        <button type="submit" class="btn btn-primary float-end">Đăng câu trả lời</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {{#each answer}}
                        <div class="d-flex flex-start mt-4">
                            <a class="me-3" href="#">
                                <img class="rounded-circle shadow-1-strong me-3" src="/icons/person-circle.svg"
                                    alt="avatar" width="32" height="32" />
                            </a>
                            <div class="flex-grow-1 flex-shrink-1">
                                <div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        {{#if ../../isAuthenticated}}
                                        {{#if ../../isSeller}}
                                        <p class="mb-1">
                                            Tôi <span class="small">- {{format_QAtime (convert_to_local created_at)}}</span>
                                        </p>
                                        {{/if}}
                                        {{else}}
                                        <p class="mb-1">
                                            {{seller.full_name}} <span class="small">- {{format_QAtime (convert_to_local created_at)}}</span>
                                        </p>
                                        {{/if}}
                                    </div>
                                    <p class="small mb-0">
                                        {{answer_text}}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                </div>
                {{/each}}

            </div>

            {{#if isAuthenticated}}
            {{#unless isSeller}}
            <hr class="mb-3">
            <div class="card-body p-4 mb-3">
                <form id="formQuestion" action="/product/question" method="post">
                    <label for="question" class="form-label fw-semibold">Đặt câu hỏi</label>
                    <textarea class="form-control mb-3" id="question" rows="3" name="question_text"></textarea>
                    <input type="hidden" name="product_id" value="{{product.product_id}}">
                    <button type="submit" class="btn btn-primary float-end">Đăng câu hỏi</button>
                </form>
            </div>
            {{/unless}}
            {{/if}}
        </div>
    </div>
</div>

<div class="container-fluid">
    <h1 class="fw-bold">Các sản phẩm khác</h1>
    <div class="container">
        <div class="row">
            {{#each related}}
            <div class="col-md-3 col-6">
                <div class="card p-2 h-100 border-0">
                    <img src="{{image_list.0.image_url}}" class="img-fluid rounded-3" alt="..." />
                    <div class="card-body">
                        <h5 class="card-title">{{product_name}}</h5>
                        <p class="card-text fw-bold">{{format_currency current_price}}</p>
                        <p class="card-text">Bidder dẫn đầu: {{mask_name highest_bidder.full_name}}</p>
                        <p class="card-text">Giá mua ngay: {{format_currency buy_now_price}}</p>
                        <p class="card-text">Bắt đầu: {{format_datetime created_at}}</p>
                        <p class="card-text">Kết thúc: {{format_endDatetime end_time}}</p>
                        <p class="card-text">Lượt ra giá: {{bid_count}}</p>
                        <a href="/product/details/{{product_id}}" class="stretched-link"></a>
                    </div>
                </div>
            </div>
            {{/each}}
        </div>
    </div>
</div>