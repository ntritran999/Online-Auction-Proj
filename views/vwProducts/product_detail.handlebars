{{#if fromAdmin}}
<div class="container-md mt-3">
    <a href="/admin?proPage={{adminProPage}}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Quay về Admin
    </a>
</div>
{{/if}}

<div class="container-md my-5">
    <div class="row">
        <div class="col-md-7 mb-3 m-md-0">
            <div class="bg-body-secondary rounded mb-3" style="height: 500px;">
                <img src="{{main_image.image_url}}" alt="" class="object-fit-contain h-100 w-100 p-5">
            </div>

            <div id="carouselId" class="carousel carousel-dark slide">
                <div class="carousel-inner" role="listbox">
                    {{#each slides}}
                    <div class="carousel-item {{#if (eq @index 0)}}active{{/if}}">
                        <div class="row justify-content-center">
                            {{#each this}}
                            <div class="col-2" style="height: 100px;">
                                <img src="{{image_url}}" class="object-fit-contain h-100 w-100 d-block stretched-link" 
                                     alt="Product image" data-bs-toggle="modal" data-bs-target="#img{{@index}}" />
                            </div>
                            <div class="modal fade" id="img{{@index}}" tabindex="-1" role="dialog" 
                                 aria-labelledby="modalTitleId" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered" role="document">
                                    <div class="modal-content">
                                        <div class="modal-body">
                                            <img src="{{image_url}}" alt="" class="img-fluid">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {{/each}}
                        </div>
                    </div>
                    {{/each}}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselId" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselId" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </div>

        <div class="col-md-5">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h5 class="fw-bold">{{product.product_name}}</h5>
                {{#if isAuthenticated}}
                {{#if (eq currentUser.role 'bidder')}}
                <button class="btn btn-outline-danger btn-sm" id="watchlistBtn" data-product-id="{{product.product_id}}">
                    <i class="bi bi-heart" id="watchlistIcon"></i>
                </button>
                {{/if}}
                {{/if}}
            </div>
            <hr>

            <div class="row">
                <div class="col-5">
                    <h6 class="fw-bold">Seller: {{seller.full_name}} 
                        <small class="text-muted">({{seller.total_rating}})</small>
                    </h6>
                    <p class="text-decoration-underline ps-2">
                        {{positive_percentage seller.rating_plus seller.total_rating}}% đánh giá tích cực
                    </p>
                </div>
                <div class="col-1">
                    <div class="vr" style="height: 100%;"></div>
                </div>
                {{#if top_bidder}}
                <div class="col-5">
                    <h6 class="fw-bold">Bidder dẫn đầu: {{mask_name top_bidder.full_name}}
                        <small class="text-muted">({{top_bidder.total_rating}})</small>
                    </h6>
                    <p class="text-decoration-underline ps-2">
                        {{positive_percentage top_bidder.rating_plus top_bidder.total_rating}}% đánh giá tích cực
                    </p>
                </div>
                {{/if}}
            </div>
            <hr>

            <h4>Giá hiện tại: <span class="fw-bold text-primary" id="currentPrice">{{format_currency product.current_price}}</span></h4>
            <p>Bước giá: <strong>{{format_currency product.step_price}}</strong></p>
            <p>Lượt ra giá: <strong id="bidCount">{{product.bid_count}}</strong></p>
            <p>Ngày mở bán: {{format_datetime product.created_at}}</p>
            <p class="text-danger">Ngày kết thúc: {{format_endDatetime product.end_time}}</p>
            <h4>Mua ngay với: <span class="fw-bold">{{format_currency product.buy_now_price}}</span></h4>
            
            {{#if isAuthenticated}}
            {{#if (eq currentUser.role 'bidder')}}
            <div class="mt-4">
                <button class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#bidModal">
                    <i class="bi bi-hammer"></i> Đặt giá
                </button>
                <a href="/bidder/bid-history/{{product.product_id}}" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-clock-history"></i> Xem lịch sử đấu giá
                </a>
            </div>
            {{/if}}
            {{else}}
            <div class="alert alert-info mt-4">
                <a href="/login">Đăng nhập</a> để tham gia đấu giá
            </div>
            {{/if}}
            <hr>
        </div>
    </div>

    <div class="container-fluid border mt-5 p-3">
        <h3 class="fw-bold">Mô tả sản phẩm</h3>
        <p>{{{product.description}}}</p>
    </div>
</div>

<!-- Bid Modal -->
<div class="modal fade" id="bidModal" tabindex="-1" aria-labelledby="bidModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bidModalLabel">Đặt giá</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Giá hiện tại:</label>
                    <p class="fw-bold text-primary" id="modalCurrentPrice">{{format_currency product.current_price}}</p>
                </div>
                <div class="mb-3">
                    <label class="form-label">Giá tối thiểu phải đặt:</label>
                    <p class="fw-bold" id="minBidPrice"></p>
                </div>
                <div class="mb-3">
                    <label for="bidAmount" class="form-label">Giá của bạn (VNĐ):</label>
                    <input type="number" class="form-control" id="bidAmount" 
                           placeholder="Nhập giá đặt" min="{{product.current_price}}" step="{{product.step_price}}">
                    <div class="form-text">Bước giá: {{format_currency product.step_price}}</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="confirmBidBtn">Xác nhận đặt giá</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <h1 class="fw-bold">Các sản phẩm khác</h1>
    <div class="container">
        <div class="row">
            {{#each related}}
            <div class="col-md-3 col-6">
                <div class="card p-2 h-100 border-0">
                    <img src="{{image_list.0.image_url}}" class="img-fluid rounded-3" alt="..." />
                    <div class="card-body">
                        <h5 class="card-title">{{product_name}}</h5>
                        <p class="card-text fw-bold">{{format_currency current_price}}</p>
                        <p class="card-text">Bidder dẫn đầu: {{mask_name highest_bidder.full_name}}</p>
                        <p class="card-text">Giá mua ngay: {{format_currency buy_now_price}}</p>
                        <p class="card-text">Bắt đầu: {{format_datetime created_at}}</p>
                        <p class="card-text">Kết thúc: {{format_endDatetime end_time}}</p>
                        <p class="card-text">Lượt ra giá: {{bid_count}}</p>
                        <a href="/product/details/{{product_id}}" class="stretched-link"></a>
                    </div>
                </div>
            </div>
            {{/each}}
        </div>
    </div>
</div>

<script>
const productId = '{{product.product_id}}';
const currentPrice = {{product.current_price}};
const stepPrice = {{product.step_price}};

// Watchlist functionality
{{#if isAuthenticated}}
{{#if (eq currentUser.role 'bidder')}}
document.addEventListener('DOMContentLoaded', async function() {
    // Check watchlist status
    try {
        const response = await fetch(`/bidder/watchlist/check/${productId}`);
        const data = await response.json();
        
        const icon = document.getElementById('watchlistIcon');
        if (data.inWatchlist) {
            icon.classList.remove('bi-heart');
            icon.classList.add('bi-heart-fill');
        }
    } catch (error) {
        console.error(error);
    }

    // Toggle watchlist
    document.getElementById('watchlistBtn').addEventListener('click', async function() {
        try {
            const response = await fetch(`/bidder/watchlist/toggle/${productId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();
            
            if (data.success) {
                const icon = document.getElementById('watchlistIcon');
                if (data.action === 'added') {
                    icon.classList.remove('bi-heart');
                    icon.classList.add('bi-heart-fill');
                } else {
                    icon.classList.remove('bi-heart-fill');
                    icon.classList.add('bi-heart');
                }
                alert(data.message);
            } else {
                alert(data.message);
            }
        } catch (error) {
            console.error(error);
            alert('Có lỗi xảy ra');
        }
    });

    // Calculate minimum bid
    const minBid = currentPrice + stepPrice;
    document.getElementById('minBidPrice').textContent = minBid.toLocaleString('vi-VN') + ' VNĐ';
    document.getElementById('bidAmount').min = minBid;

    // Confirm bid
    document.getElementById('confirmBidBtn').addEventListener('click', async function() {
        const bidAmount = parseFloat(document.getElementById('bidAmount').value);
        
        if (!bidAmount || bidAmount < minBid) {
            alert('Giá đặt không hợp lệ!');
            return;
        }

        if (!confirm(`Bạn có chắc chắn muốn đặt giá ${bidAmount.toLocaleString('vi-VN')} VNĐ?`)) {
            return;
        }

        try {
            const response = await fetch('/bidder/bid', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productId, bidAmount })
            });

            const data = await response.json();
            
            if (data.success) {
                alert(data.message);
                
                // Update UI
                document.getElementById('currentPrice').textContent = 
                    data.newPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
                document.getElementById('modalCurrentPrice').textContent = 
                    data.newPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
                document.getElementById('bidCount').textContent = data.bidCount;
                
                // Close modal and reset
                bootstrap.Modal.getInstance(document.getElementById('bidModal')).hide();
                document.getElementById('bidAmount').value = '';
                
                // Reload page to update all info
                setTimeout(() => location.reload(), 1000);
            } else {
                alert(data.message);
            }
        } catch (error) {
            console.error(error);
            alert('Có lỗi xảy ra khi đặt giá');
        }
    });
});
{{/if}}
{{/if}}
</script>